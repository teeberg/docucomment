{% extends "main/base.html" %}

{% block title %}{{document.name}}{% endblock %}

{% block head %}
<script type="text/javascript">
	function displayPage(pagenumber) {
		pdf.getPage(pagenumber).then(function(page) {
			var scale = 1.5;
			var viewport = page.getViewport(scale);
			var canvas = document.getElementById('pdf-canvas');
			var context = canvas.getContext('2d');
			canvas.height = viewport.height;
			canvas.width = viewport.width;
			page.render({canvasContext: context, viewport: viewport});
			curpage = pagenumber;
			$("#page").html("Page " + curpage + " of " + pdf.numPages);
			loadComments(pagenumber);
		});
	}

	function gotoPage(page) {
		pushPage(page);
		displayPage(page);
	}

	function loadComments(page) {
		$.getJSON("/document/{{ document.hash }}/page/" + page + "/comments", function(data) {
			$("#comments").empty();
			$.each(data, function(i, comment) {
				var c = $("<div class='comment' id='comment-" + comment['id'] + "'></div>");
				$(c).append("<div class='comment-nickname'>" + comment['nickname'] + "</div>");
				$(c).append("<div class='comment-comment'>" + comment['comment'] + "</div>");

				var a = $("<a href=\"\">edit</a>").click(function() {
					$("#post-comment #id_nickname").attr("value", comment['nickname']);
					$("#post-comment #id_comment").html(comment['comment']);
					$("#post-comment #id_cancel").css("display", "inline");
					return false;
				});
				$(c).append(a);

				c.appendTo("#comments");
			});
		});
	}

	function pushPage(page) {
		window.history.pushState(page, "title", "/document/{{document.hash}}?page="+page);
	}

	var url = '/document/{{ document.hash }}/file';
	var curpage = 0;
	var pdf;
	var startpage;

	function nextPage() {
		if(curpage < pdf.numPages) {
			curpage++;
			gotoPage(curpage);
		}
	}

	function previousPage() {
		if(curpage > 1) {
			curpage--;
			gotoPage(curpage);
		}
	}

	$(function() {

		$(document).keydown(function(e) {
			if(e.keyCode == 37) {
				// left arrow
				previousPage();
				return false;
			}
			else if(e.keyCode == 39) {
				// right arrow
				nextPage();
				return false;
			}
		});
		$(".prev").click(function() {
			nextPage();
			return false;
		});
		$(".next").click(function() {
			previousPage();
			return false;
		});
		$(".last").click(function() {
			gotoPage(pdf.numPages);
			return false;
		});
		$(".comment-edit a").click(function() {
			alert("yes");
			return false;
		});
		$("#post-comment").submit(function(event) {
			console.log(event);
			$.ajax({
				url: '/document/{{ document.hash }}/page/' + curpage + '/comment',
				type: "post",
				data: $(this).serialize()
			}).done(function(data) {
				loadComments(curpage);
			});
			event.preventDefault();
		});
		var c = $("<button id='id_cancel'>Cancel</button>");
		$(c).click(function() {
			$("#post-comment #id_nickname").value("");
			$("#post-comment #id_comment").html("");
			$("#post-comment #id_cancel").css("display", "none");
		});
		$(c).css("display", "none");
		$("#post-comment").append(c);
		
		window.onpopstate = function(e){
			if(e.state) {
				displayPage(e.state);
			}
			else {
				displayPage(startpage);
			}
		};

		PDFJS.disableWorker = true;
		PDFJS.getDocument(url).then(function(p) {
			pdf = p;
			startpage = Math.max(1,Math.min(p.numPages,{{page}}));
			displayPage(startpage);
		});
	});
</script>
{% endblock %}

{% block body %}
<h1><a href="/">Home</a> >> {{ document.name }}</h1>
<div id="mainbar">
	<h2 id="page">Page 1</h2>
	<canvas id="pdf-canvas"></canvas>	

	<div style="font-size: 2em"><a href="javascript:gotoPage(1)" class="first">&lt;&lt;</a> <a href="" class="prev">&lt;</a> <a href="" class="next">&gt;</a> <a href ="" class="last">&gt;&gt;</a></div>
	<p>Remember to bookmark this page.</p>
	<p>People uploading the exact same file will be redirected here.</p>
</div>

<div id="sidebar">
	<h2>Comments</h2>
	<div id="comments"></div>
	<form id="post-comment" method="post">
		{{ commentForm.as_p }}
		<button type="submit">Comment</button>
	</form>
</div>
{% endblock %}
