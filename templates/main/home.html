{% extends "main/base.html" %}

{% block title %}Docucomment{% endblock %}

{% block head %}
<script type="text/javascript">

function loadComments() {
	$.getJSON("/comments", function(data) {
		$("#comments").empty();
		$.each(data, function(i, comment) {
			var c;
			if (comment.document_public) {
				console.log("public");
				c = $("<div class='comment' data-url='/document/" + comment.document_hash + "?page=" + comment.page + "'></div>");
			} else {
				c = $("<div class='comment'></div>");
			}
			var head = $("<div class='comment-head'></div>");
			var links = $("<div class='comment-links'></div>");
			if (comment.document_public) {
				var view_link = $("<a href='/document/" + comment.document_hash + "?page=" + comment.page + "'>view</a>");
				$(links).append(view_link);
			}
			$(head).append("<span class='comment-nickname'>" + comment['nickname'] + "</span>");
			$(head).append(links);
			$(c).append(head);
			$(c).append("<div class='comment-comment'>" + comment['comment'] + "</div>");

			$(c).appendTo("#comments");
		});
		MathJax.Hub.Queue(["Typeset", MathJax.Hub, $("#comments")[0]]);
		SyntaxHighlighter.highlight();
	});
}

$(function() {
	loadComments();
	$(".comment").click(function() {
		var url = $(this).data("url");
		if(url == undefined) {
			alert("This PDF is private. You must upload it or know its hash to view this comment.");
		}
		else {
			window.location.href = url;
		}
		return false;
	});
});

</script>
{% endblock %}

{% block body %}

	<div id="documents-bar">
		<h2>Documents</h2>
		<form id="form-post-document" method="post" enctype="multipart/form-data">
			<h3>Upload a document</h3>
			{{ uploadForm.as_p }}
			<button type="submit">Upload</button>
		</form>
		{% if documents %}
			<div id="documents">
				<ul>
				{% for document in documents %}
					<li>
					{% if document.public %}
						<a href="document/{{ document.hash }}">{{ document.name }}</a></li>
					{% else %}
						{{ document.name }}
					{% endif %}
				{% endfor %}
				</ul>
			</div>
		{% else %}
			<p>No public documents.</p>
		{% endif %}
	</div>

	<div id="comments-bar">
		{% if comments %}
			<h2>{{comments|length}} Comments</h2>
			<div id="comments">
			</div>
		{% else %}
			<p>No comments.</p>
		{% endif %}
	</div>

{% endblock %}
